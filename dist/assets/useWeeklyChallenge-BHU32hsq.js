import{a as C,r as c,s}from"./index-CF1n9Zjo.js";const b=()=>{const{user:t}=C(),[a,d]=c.useState({challenge:null,participants:[],userParticipation:null,userRank:null,daysLeft:0,isLoading:!0}),i=c.useCallback(async()=>{if(t)try{const{data:r}=await s.rpc("get_or_create_weekly_challenge");if(!r){d(e=>({...e,isLoading:!1}));return}const[l,u]=await Promise.all([s.from("weekly_challenges").select("*").eq("id",r).maybeSingle(),s.from("weekly_challenge_participants").select("*").eq("challenge_id",r).order("xp_earned",{ascending:!1})]),n=l.data,g=u.data||[],v=g.map(e=>e.user_id),{data:_}=await s.from("profiles").select("user_id, full_name, avatar_url").in("user_id",v),h=new Map((_==null?void 0:_.map(e=>[e.user_id,e]))||[]),f=g.map((e,p)=>{var m,y;return{...e,rank:p+1,full_name:((m=h.get(e.user_id))==null?void 0:m.full_name)||"Noma'lum",avatar_url:(y=h.get(e.user_id))==null?void 0:y.avatar_url}}),o=f.find(e=>e.user_id===t.id)||null,x=(o==null?void 0:o.rank)||null;let w=0;if(n!=null&&n.week_end){const e=new Date(n.week_end);e.setHours(23,59,59);const p=new Date;w=Math.max(0,Math.ceil((e.getTime()-p.getTime())/(1e3*60*60*24)))}d({challenge:n,participants:f,userParticipation:o,userRank:x,daysLeft:w,isLoading:!1})}catch(r){console.error("Error fetching challenge:",r),d(l=>({...l,isLoading:!1}))}},[t]),k=c.useCallback(async()=>{if(!t||!a.challenge)return!1;try{const{error:r}=await s.from("weekly_challenge_participants").upsert({challenge_id:a.challenge.id,user_id:t.id,xp_earned:0,words_reviewed:0,words_correct:0,days_active:0},{onConflict:"challenge_id,user_id"});if(r)throw r;return await i(),!0}catch(r){return console.error("Error joining challenge:",r),!1}},[t,a.challenge,i]),P=c.useCallback(async(r,l,u)=>{if(!(!t||!a.challenge||!a.userParticipation))try{await s.from("weekly_challenge_participants").update({xp_earned:a.userParticipation.xp_earned+r,words_reviewed:a.userParticipation.words_reviewed+l,words_correct:a.userParticipation.words_correct+u,updated_at:new Date().toISOString()}).eq("challenge_id",a.challenge.id).eq("user_id",t.id)}catch(n){console.error("Error updating participant stats:",n)}},[t,a.challenge,a.userParticipation]);return c.useEffect(()=>{i()},[i]),{...a,joinChallenge:k,updateParticipantStats:P,refetch:i}};export{b as u};
