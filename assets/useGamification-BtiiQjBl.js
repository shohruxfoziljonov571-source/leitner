import{r as n,a as A,e as B,s as c,b as P}from"./index-H5eLpdEA.js";const j={1:1*60*60*1e3,2:5*60*60*1e3,3:24*60*60*1e3,4:5*24*60*60*1e3,5:30*24*60*60*1e3},C=()=>({total_words:0,learned_words:0,streak:0,today_reviewed:0,today_correct:0,last_active_date:new Date().toISOString().split("T")[0]}),H=()=>{const[o,v]=n.useState([]),[p,y]=n.useState(C()),[h,x]=n.useState(!0),{user:i}=A(),{activeLanguage:a}=B(),w=n.useCallback(async()=>{if(!i||!a){v([]);return}try{const{data:e,error:t}=await c.from("words").select("*").eq("user_id",i.id).eq("user_language_id",a.id).order("created_at",{ascending:!1});if(t)throw t;v(e||[])}catch(e){console.error("Error fetching words:",e)}},[i,a]),f=n.useCallback(async()=>{if(!i||!a){y(C());return}try{const{data:e,error:t}=await c.from("user_stats").select("*").eq("user_id",i.id).eq("user_language_id",a.id).maybeSingle();if(t)throw t;if(e){const r=new Date().toISOString().split("T")[0];if(e.last_active_date!==r){const d=new Date;d.setDate(d.getDate()-1);const u=d.toISOString().split("T")[0];let m=e.streak;e.last_active_date===u&&e.today_reviewed>0?m+=1:e.last_active_date!==r&&(m=0),await c.from("user_stats").update({today_reviewed:0,today_correct:0,streak:m,last_active_date:r}).eq("id",e.id),y({...e,today_reviewed:0,today_correct:0,streak:m,last_active_date:r})}else y(e)}else await c.from("user_stats").insert({user_id:i.id,user_language_id:a.id}),y(C())}catch(e){console.error("Error fetching stats:",e)}},[i,a]);n.useEffect(()=>{i&&a?(x(!0),Promise.all([w(),f()]).finally(()=>{x(!1)})):(v([]),y(C()),x(!1))},[i,a]);const E=n.useCallback(e=>o.some(t=>t.original_word.toLowerCase().trim()===e.toLowerCase().trim()),[o]),O=n.useCallback(async e=>{if(!i||!a)return null;if(E(e.original_word))return{error:"duplicate",existingWord:e.original_word};try{const{data:t,error:r}=await c.from("words").insert({user_id:i.id,user_language_id:a.id,original_word:e.original_word,translated_word:e.translated_word,source_language:e.source_language,target_language:e.target_language,example_sentences:e.example_sentences||[],box_number:1,next_review_time:new Date().toISOString(),category_id:e.category_id||null}).select().single();if(r)throw r;return v(d=>[t,...d]),await c.from("user_stats").update({total_words:p.total_words+1}).eq("user_id",i.id).eq("user_language_id",a.id),y(d=>({...d,total_words:d.total_words+1})),t}catch(t){return console.error("Error adding word:",t),null}},[i,a,p.total_words,E]),W=n.useCallback(async e=>{if(!i||!a||e.length===0)return{added:[],duplicates:[]};const t=new Set(o.map(u=>u.original_word.toLowerCase().trim())),r=[],d=[];if(e.forEach(u=>{const m=u.original_word.toLowerCase().trim();t.has(m)?d.push(u.original_word):(r.push(u),t.add(m))}),r.length===0)return{added:[],duplicates:d};try{const u=r.map(_=>({user_id:i.id,user_language_id:a.id,original_word:_.original_word,translated_word:_.translated_word,source_language:_.source_language,target_language:_.target_language,example_sentences:_.example_sentences||[],box_number:1,next_review_time:new Date().toISOString(),category_id:_.category_id||null})),{data:m,error:L}=await c.from("words").insert(u).select();if(L)throw L;v(_=>[...m||[],..._]);const S=p.total_words+r.length;return await c.from("user_stats").update({total_words:S}).eq("user_id",i.id).eq("user_language_id",a.id),y(_=>({..._,total_words:S})),{added:m||[],duplicates:d}}catch(u){return console.error("Error bulk adding words:",u),{added:[],duplicates:d}}},[i,a,p.total_words,o]),z=n.useCallback(async(e,t)=>{if(!i||!a)return null;try{const{data:r,error:d}=await c.from("words").update(t).eq("id",e).select().single();if(d)throw d;return v(u=>u.map(m=>m.id===e?{...m,...r}:m)),r}catch(r){return console.error("Error updating word:",r),null}},[i,a]),I=n.useCallback(async e=>{if(!(!i||!a))try{const{error:t}=await c.from("words").delete().eq("id",e);if(t)throw t;v(r=>r.filter(d=>d.id!==e)),await c.from("user_stats").update({total_words:Math.max(0,p.total_words-1)}).eq("user_id",i.id).eq("user_language_id",a.id),y(r=>({...r,total_words:Math.max(0,r.total_words-1)}))}catch(t){console.error("Error deleting word:",t)}},[i,a,p.total_words]),s=n.useCallback(async(e,t)=>{if(!i||!a)return;const r=o.find(_=>_.id===e);if(!r)return;const d=r.box_number,u=t?Math.min(5,r.box_number+1):1,m=t&&u===5&&d<5,L=j[u],S=new Date().toISOString().split("T")[0];try{const{error:_}=await c.from("words").update({box_number:u,next_review_time:new Date(Date.now()+L).toISOString(),times_reviewed:r.times_reviewed+1,times_correct:t?r.times_correct+1:r.times_correct,times_incorrect:t?r.times_incorrect:r.times_incorrect+1,last_reviewed:new Date().toISOString()}).eq("id",e);if(_)throw _;v(b=>b.map(k=>k.id!==e?k:{...k,box_number:u,next_review_time:new Date(Date.now()+L).toISOString(),times_reviewed:k.times_reviewed+1,times_correct:t?k.times_correct+1:k.times_correct,times_incorrect:t?k.times_incorrect:k.times_incorrect+1,last_reviewed:new Date().toISOString()})),y(b=>{const k={...b,today_reviewed:b.today_reviewed+1,today_correct:t?b.today_correct+1:b.today_correct,learned_words:m?b.learned_words+1:b.learned_words,last_active_date:S};return c.from("user_stats").update({today_reviewed:k.today_reviewed,today_correct:k.today_correct,learned_words:k.learned_words,last_active_date:S}).eq("user_id",i.id).eq("user_language_id",a.id).then(({error:X})=>{X&&console.error("Error updating user_stats:",X)}),k});const{data:D}=await c.from("daily_stats").select("*").eq("user_id",i.id).eq("user_language_id",a.id).eq("date",S).maybeSingle();D?await c.from("daily_stats").update({words_reviewed:(D.words_reviewed||0)+1,words_correct:t?(D.words_correct||0)+1:D.words_correct||0}).eq("id",D.id):await c.from("daily_stats").insert({user_id:i.id,user_language_id:a.id,date:S,words_reviewed:1,words_correct:t?1:0})}catch(_){console.error("Error reviewing word:",_)}},[i,a,o]),q=n.useCallback(()=>{const e=new Date;return o.filter(t=>new Date(t.next_review_time)<=e)},[o]),l=n.useCallback(e=>o.filter(t=>t.box_number===e),[o]),g=n.useCallback(()=>{const e={1:0,2:0,3:0,4:0,5:0};return o.forEach(t=>{e[t.box_number]++}),e},[o]);return{words:o,stats:p,isLoading:h,addWord:O,addWordsBulk:W,updateWord:z,deleteWord:I,reviewWord:s,getWordsForReview:q,getWordsByBox:l,getBoxCounts:g,refetch:w}},R=[{id:"first_word",name:"Birinchi qadam",description:"Birinchi so'zni qo'shing",icon:"ðŸŒ±",requirement:1,type:"words"},{id:"word_10",name:"O'ntalik",description:"10 ta so'z qo'shing",icon:"ðŸ“š",requirement:10,type:"words"},{id:"word_50",name:"Elliktalik",description:"50 ta so'z qo'shing",icon:"ðŸ“–",requirement:50,type:"words"},{id:"word_100",name:"Yuztalik",description:"100 ta so'z qo'shing",icon:"ðŸŽ“",requirement:100,type:"words"},{id:"word_250",name:"Lug'at bilimdon",description:"250 ta so'z qo'shing",icon:"ðŸ“•",requirement:250,type:"words"},{id:"word_500",name:"Lug'at ustasi",description:"500 ta so'z qo'shing",icon:"ðŸ†",requirement:500,type:"words"},{id:"word_1000",name:"Poliglot",description:"1000 ta so'z qo'shing",icon:"ðŸ‘‘",requirement:1e3,type:"words"},{id:"word_2000",name:"Leksikograf",description:"2000 ta so'z qo'shing",icon:"ðŸŒ",requirement:2e3,type:"words"},{id:"streak_3",name:"Muntazam",description:"3 kunlik streak",icon:"ðŸ”¥",requirement:3,type:"streak"},{id:"streak_7",name:"Haftalik",description:"7 kunlik streak",icon:"âš¡",requirement:7,type:"streak"},{id:"streak_14",name:"Ikki haftalik",description:"14 kunlik streak",icon:"ðŸ’«",requirement:14,type:"streak"},{id:"streak_30",name:"Oylik",description:"30 kunlik streak",icon:"ðŸ’Ž",requirement:30,type:"streak"},{id:"streak_60",name:"Ikki oylik",description:"60 kunlik streak",icon:"ðŸŒˆ",requirement:60,type:"streak"},{id:"streak_100",name:"Yuz kunlik",description:"100 kunlik streak",icon:"ðŸ…",requirement:100,type:"streak"},{id:"streak_365",name:"Yillik chempion",description:"365 kunlik streak",icon:"ðŸ†",requirement:365,type:"streak"},{id:"reviews_50",name:"Boshlovchi takrorlovchi",description:"50 ta takror",icon:"ðŸ”",requirement:50,type:"reviews"},{id:"reviews_100",name:"Takrorlovchi",description:"100 ta takror",icon:"ðŸ”„",requirement:100,type:"reviews"},{id:"reviews_250",name:"Faol takrorlovchi",description:"250 ta takror",icon:"â­",requirement:250,type:"reviews"},{id:"reviews_500",name:"Super takrorlovchi",description:"500 ta takror",icon:"ðŸŒŸ",requirement:500,type:"reviews"},{id:"reviews_1000",name:"Mega takrorlovchi",description:"1000 ta takror",icon:"ðŸ’¥",requirement:1e3,type:"reviews"},{id:"reviews_2500",name:"Ultra takrorlovchi",description:"2500 ta takror",icon:"ðŸš€",requirement:2500,type:"reviews"},{id:"reviews_5000",name:"Takror qiroli",description:"5000 ta takror",icon:"ðŸ‘‘",requirement:5e3,type:"reviews"},{id:"accuracy_80",name:"Aniq",description:"80% aniqlikka erishing (min 100 ta takror)",icon:"ðŸŽ¯",requirement:80,type:"accuracy"},{id:"accuracy_90",name:"Juda aniq",description:"90% aniqlikka erishing (min 100 ta takror)",icon:"ðŸ¹",requirement:90,type:"accuracy"},{id:"accuracy_95",name:"Mukammal",description:"95% aniqlikka erishing (min 200 ta takror)",icon:"ðŸ’¯",requirement:95,type:"accuracy"},{id:"level_5",name:"O'rganuvchi",description:"5-darajaga yeting",icon:"â­",requirement:5,type:"level"},{id:"level_10",name:"Tajribali",description:"10-darajaga yeting",icon:"ðŸŒ™",requirement:10,type:"level"},{id:"level_20",name:"Professional",description:"20-darajaga yeting",icon:"ðŸŒŸ",requirement:20,type:"level"},{id:"level_30",name:"Ekspert",description:"30-darajaga yeting",icon:"ðŸ’«",requirement:30,type:"level"},{id:"level_50",name:"Usta",description:"50-darajaga yeting",icon:"ðŸ†",requirement:50,type:"level"},{id:"level_100",name:"Grandmaster",description:"100-darajaga yeting",icon:"ðŸ‘‘",requirement:100,type:"level"}],M=10,N=2,U=5,T=100,F=o=>Math.floor(o/T)+1,Y=o=>o*T,G=o=>o%T,$=()=>{const[o,v]=n.useState(0),[p,y]=n.useState(1),[h,x]=n.useState([]),[i,a]=n.useState(!0),{user:w}=A(),{activeLanguage:f}=B(),E=n.useCallback(async()=>{if(!w||!f){a(!1);return}try{const{data:s,error:q}=await c.from("user_stats").select("xp, level, achievements").eq("user_id",w.id).eq("user_language_id",f.id).maybeSingle();if(q)throw q;s&&(v(s.xp||0),y(s.level||1),x(s.achievements||[]))}catch(s){console.error("Error fetching gamification data:",s)}finally{a(!1)}},[w,f]);n.useEffect(()=>{E()},[E]);const O=n.useCallback(async(s,q)=>{if(!w||!f)return;const l=o+s,g=F(l),e=g>p;try{await c.from("user_stats").update({xp:l,level:g}).eq("user_id",w.id).eq("user_language_id",f.id),v(l),y(g);const t=new Date().toISOString().split("T")[0];await c.from("daily_stats").upsert({user_id:w.id,user_language_id:f.id,date:t,xp_earned:s},{onConflict:"user_id,user_language_id,date"}),e&&P.success(`ðŸŽ‰ Tabriklaymiz! ${g}-darajaga yetdingiz!`,{duration:4e3})}catch(t){console.error("Error adding XP:",t)}},[w,f,o,p]),W=n.useCallback(async s=>{if(!w||!f)return;const q=[];for(const l of R){if(h.includes(l.id))continue;let g=!1;switch(l.type){case"words":s.totalWords&&s.totalWords>=l.requirement&&(g=!0);break;case"streak":s.streak&&s.streak>=l.requirement&&(g=!0);break;case"reviews":s.totalReviews&&s.totalReviews>=l.requirement&&(g=!0);break;case"level":s.level&&s.level>=l.requirement&&(g=!0);break}g&&(q.push(l.id),P.success(`ðŸ† Yangi yutuq: ${l.name}!`,{description:l.description,duration:5e3}))}if(q.length>0){const l=[...h,...q];try{await c.from("user_stats").update({achievements:l}).eq("user_id",w.id).eq("user_language_id",f.id),x(l)}catch(g){console.error("Error updating achievements:",g)}}},[w,f,h]),z=n.useCallback(()=>R.filter(s=>h.includes(s.id)),[h]),I=n.useCallback(()=>R.filter(s=>!h.includes(s.id)),[h]);return{xp:o,level:p,achievements:h,isLoading:i,addXp:O,checkAndUnlockAchievements:W,getUnlockedAchievements:z,getLockedAchievements:I,getCurrentLevelXp:()=>G(o),getXpForNextLevel:()=>Y(p),XP_PER_CORRECT:M,XP_PER_INCORRECT:N,XP_PER_NEW_WORD:U}};export{R as A,H as a,$ as u};
